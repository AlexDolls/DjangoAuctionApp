{% extends "market/layout.html" %}

{% block body%}
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-3 col-lg-6 order-lg-1 order-xl-1">
                <div class="card">
                    <div class="card-body p-0">
                        <!-- users -->
                        <div class="row">
                            <div class="col">
                                <div data-simplebar="init" style="max-height: 550px">
                                    <div class="simplebar-wrapper" style="margin: 0px">
                                        <div class="simplebar-height-auto-observer-wrapper">
                                            <div class="simplebar-height-auto-observer"></div>
                                        </div>
                                        <div class="simplebar-mask">
                                            <div class="simplebar-offset" style="right: 0px; bottom: 0px">
                                                <div class="simplebar-content-wrapper"
                                                     style="height: auto; overflow: hidden scroll">
                                                    <div class="simplebar-content" style="padding: 0px">
                                                        <a href="javascript:void(0);" class="text-body">
                                                            <div class="media mt-1 p-2">
                                                                <img src="assets/images/users/avatar-2.jpg"
                                                                     class="mr-2 rounded-circle"
                                                                     height="48"
                                                                     alt="Brandon Smith"/>
                                                                <div class="media-body">
                                                                    <h5 class="mt-0 mb-0 font-14">
                                                                        <span class="float-right text-muted font-12">4:30am</span> Brandon Smith
                                                                    </h5>
                                                                    <p class="mt-1 mb-0 text-muted font-14">
                                                                        <span class="w-25 float-right text-right">
                                                                            <span class="badge badge-danger-lighten">
                                                                                3
                                                                            </span>
                                                                        </span>
                                                                        <span class="w-75">How are you today?</span>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="simplebar-placeholder"
                                             style="width: 393px; height: 664px"></div>
                                    </div>

                                    <div class="simplebar-track simplebar-horizontal"
                                         style="visibility: hidden">
                                        <div class="simplebar-scrollbar"
                                             style="width: 0px; display: none"></div>
                                    </div>

                                    <div class="simplebar-track simplebar-vertical"
                                         style="visibility: visible">
                                        <div class="simplebar-scrollbar"
                                             style="height: 455px; display: block;
                                             transform: translate3d(0px, 0px, 0px);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- chat area -->
            <div class="col-xl-6 col-lg-12 order-lg-2 order-xl-1">
                <div class="card">
                    <div class="card-body">
                        <ul class="conversation-list" data-simplebar="init"
                            style="max-height: 537px">
                            <div class="simplebar-wrapper" style="margin: 0px -15px">
                                <div class="simplebar-height-auto-observer-wrapper">
                                    <div class="simplebar-height-auto-observer"></div>
                                </div>
                                <div class="simplebar-mask">
                                    <div class="simplebar-offset" style="right: 0px; bottom: 0px">
                                        <div class="simplebar-content-wrapper"
                                             style="height: auto; overflow: hidden scroll">
                                            <div class="simplebar-content" style="padding: 0px 15px">
                                                <li class="clearfix">
                                                    <div class="chat-avatar">
                                                        <img class="rounded" alt="Shreyu N"
                                                             src="assets/images/users/avatar-5.jpg"/>
                                                        <i>10:00</i>
                                                    </div>
                                                    <div class="conversation-text">
                                                        <div class="ctext-wrap">
                                                            <i>Shreyu N</i>
                                                            <p>Hello!</p>
                                                        </div>
                                                    </div>
                                                </li>

                                                <li class="clearfix odd">
                                                    <div class="chat-avatar">
                                                        <img class="rounded" alt="dominic"
                                                             src="assets/images/users/avatar-1.jpg"/>
                                                        <i>10:01</i>
                                                    </div>
                                                    <div class="conversation-text">
                                                        <div class="ctext-wrap">
                                                            <i>Dominic</i>
                                                            <p>Hi, How are you? What about our next meeting?</p>
                                                        </div>
                                                    </div>
                                                </li>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="simplebar-placeholder" style="width: 859px; height: 885px"></div>
                            </div>

                            <div class="simplebar-track simplebar-horizontal" style="visibility: hidden">
                                <div class="simplebar-scrollbar" style="width: 0px; display: none"></div>
                            </div>

                            <div class="simplebar-track simplebar-vertical" style="visibility: visible">
                                <div class="simplebar-scrollbar" style="height: 325px; display: block;
                                transform: translate3d(0px, 116px, 0px);"></div>
                            </div>
                        </ul>

                        <div class="row">
                            <div class="col">
                                <div class="mt-2 bg-light p-3 rounded">
                                    <form class="needs-validation" novalidate="" name="chat-form" id="chat-form">
                                        <div class="row">
                                            <div class="col mb-2 mb-sm-0">
                                                <input type="text" class="form-control border-0" placeholder="Enter your text" required=""/>
                                                <div class="invalid-feedback">
                                                    Please enter your messsage
                                                </div>
                                            </div>

                                            <div class="col-sm-auto">
                                                <div class="btn-group">
                                                    <a href="#" class="btn btn-light">
                                                        <i class="uil uil-paperclip"></i>
                                                    </a>
                                                    <a href="#" class="btn btn-light">
                                                        <i class="uil uil-smile"></i>
                                                    </a>
                                                    <button type="submit" class="btn btn-success chat-send btn-block">
                                                        <i class="uil uil-message"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class = "detail-parasha">
<div class="container">
  <div class = "row">
	  <div class = "col">
	  <h1><strong> Chats </strong></h1>
	  </div>
	  <div class = "col">
	  <h1><strong> Start chat with: </strong></h1>
	  </div>
	  <hr>
  </div>
  <div class="row">
    <div class="col">
	<div class = "modal-body-chat-users">
	<div class = "modal-content-chat-users">
	{% for chat in chats %}
	<h5>	
		{% if chat.members.count == 2%}
		<a href = "{% url "market:chat" chat.id %}">
		{% for member in chat.members.all %}
			{% if member.id != user.id %}
			<div class = "chat-username-line">
			<div class = "container">
				<div class = "row">
					<div class = "col-md-auto">
						<div class = "user-avatar" style="background-image: url({% if member.avatar %}{{ member.avatar.url}}{% else %}https://www.meme-arsenal.com/memes/d0aea72a4f42092ccd20a17781d7df11.jpg{% endif %});" alt="connect"></div>

					</div>
					<div class = "col-md-auto" style = "display:flex;">
						<div class = "username-flex-center">
						{{member.username}}
						</div>
						<span id="numbers_chat_unread_{{chat.id}}" class="badge rounded-pill bg-danger" id = "numbers_chat_unread_{{chat.id}}" style = "margin:auto; margin-left:10px;"></span>

					</div>
				</div>
			</div>
			</div>
			{% endif %}
		{% endfor %}
		</a>
		{% endif %}
        </h3>
	{% empty %}
	<div class="alert alert-info text-center p-4 my-4 mx-2">You have no chat's yet</div>
	{% endfor %}
		</div>
	</div>
    </div>
    <div class="col">
	    <div class = "modal-body-chat-users">
		<div class = "modal-content-chat-users">
	    {% if site_users %}
	    <form action = "{% url 'market:inbox' %}" method = "post">
	    {% csrf_token %}
	    <div id = "user-list">
		<select class = "form-select" size = "13" name = "user_id">
		{% for item in site_users %}
		<option value = '{{item.id}}' >{{item.username}}</option>
		{% endfor %}
		</select>
	    </div>

	    {% else %}
	    <div class="alert alert-info text-center p-4 my-4 mx-2">There's no users to start chat with for now :(</div>
	    {% endif %}
	    </div>
	</div>
	{% if site_users %}<input type = 'submit' class = "btn btn-primary" value = "Create chat!" style = "margin-top:1rem; width:90%;"> {% endif %}
	</form>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block chat_script %}
     	<script type = 'text/javascript'>      
                chatSocket = new WebSocket(
                        'ws://'
                        + window.location.host
                        + '/ws/market/'
                        +'inbox'
                        +'/'
                                );
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
                if (data.message){
                document.querySelector('#inbox-message').innerHTML = data.user_inbox;
                }
        };
	
	var sum_chat_unread = 0;
        {% for chat_item in chats %}
                {% for message_item in chat_item.message_set.all %}
                        {% if message_item.sender_id != user.id and message_item.unread%}
                                sum_chat_unread += 1;
                        {% endif%}
                {% endfor %}
		document.querySelector('#numbers_chat_unread_{{chat_item.id}}').innerHTML = sum_chat_unread;
		sum_chat_unread = 0;
        {% endfor %}

	var n = 0;
	
	$(".chat-username-line").mouseenter(function() {
	    $(this).attr("style", "background-color:rgba(255, 255, 255, 0.4); border-radius:7px; padding: 5px;");
	}).mouseleave(function() {
	    $(this).attr("style", "");
	});

        </script>

{% endblock %}

