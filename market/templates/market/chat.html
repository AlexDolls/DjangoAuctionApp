{% extends "market/layout.html" %}

{% block body %}
<h3 class = "p-3" style = "color:white;"><strong>{% if user.username == chat.members.all.0.username %}{{ chat.members.all.1.username }}{% else %}{{ chat.members.all.0.username }}{% endif %}</strong></h3>	

	<div id = 'messages-field'>
	{% for message in messages %}
	{% if user.id == message.sender_id %}
	<div class="container-for-chat darker">
        <img src="https://i.pinimg.com/originals/e2/42/9a/e2429ab30c83e3935da91d0be1e42282.png" alt="Avatar" class="right">
	<p>{{message.text}}</p>
        </div>

	{% else %}
	 <div class="container-for-chat">
        <img src="https://cdnb.artstation.com/p/users/avatars/001/826/401/large/b6ed840673e6785a694e47f83aacc589.jpg?1584628467" alt="Avatar">
	<p>{{message.text}}</p>
        </div>
	{% endif %}
	{% endfor %}
	</div>
	<div class="form-floating" style:'text-aling:right;'>
	<textarea class = "form-control" id = "message-input" placeholder = "Message text" style = "height: 100px; width:50%;"></textarea><br><br>
	<label for="floatingTextarea2">Message Text</label>
	</div>
	<input type = "button" id = "message-submit" value = "Send message" class = "btn-primary btn-lg">

{% endblock %}
{% block chat_script %}
<script type = 'text/javascript'>      
                chatSocket = new WebSocket(
                        'ws://'
                        + window.location.host
                        + '/ws/market/'
                        +'inbox'
                        +'/'
                                );
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
	    if (data.message){
		if (data.send_self){
		document.querySelector('#messages-field').innerHTML +='<div class="container-for-chat darker">'
        							+'<img src="https://i.pinimg.com/originals/e2/42/9a/e2429ab30c83e3935da91d0be1e42282.png" alt="Avatar" class="right">'
        							+'<p>'
								+data.message
								+'</p>'
								+'</div>';
			}
		else{
            	document.querySelector('#messages-field').innerHTML += '<div class="container-for-chat">'
                                                                +'<img src="https://cdnb.artstation.com/p/users/avatars/001/826/401/large/b6ed840673e6785a694e47f83aacc589.jpg?1584628467" alt="Avatar">'
                                                                +'<p>'
                                                                +data.message
                                                                +'</p>'
                                                                +'</div>';
 


		}

		}
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#message-input').focus();
        document.querySelector('#message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#message-submit').click();
            }   
        };

        document.querySelector('#message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#message-input');
            const message = messageInputDom.value;
            const sender_id = '{{ user.id }}';
            const chat_id = '{{ chat.id }}';
            chatSocket.send(JSON.stringify({
                'new_message_text': message,
                'sender_id':sender_id,
                'chat_id':chat_id,
                'new_chat':'',
            }));
            messageInputDom.value = '';
        };
        </script>
{% endblock %}
